<?php

namespace Tests\Unit\Commands\MySql;

use App\Models\Setting;
use App\Support\Console\DockerCompose\CliCommand;
use Illuminate\Support\Facades\Artisan;
use Tests\BaseTestCase;
use Tests\Unit\Support\Concerns\MocksDockerCompose;

class OpenTest extends BaseTestCase
{
    use MocksDockerCompose;

    public function remakePorter()
    {
        $this->mockDockerCompose();

        parent::remakePorter();
    }

    /** @test */
    public function it_runs_mysql()
    {
        Setting::updateOrCreate('use_mysql', 'on');

        $this->dockerCompose->shouldReceive('runContainer')
            ->andReturn($command = \Mockery::mock(CliCommand::class));

        $command->shouldReceive('append')->andReturn($command)->once();
        $command->shouldReceive('interactive')->andReturn($command)->once();
        $command->shouldReceive('setTimeout')->with(null)->andReturn($command)->once();
        $command->shouldReceive('perform')->once();

        $this->artisan('mysql:open');
    }

    /** @test */
    public function it_does_not_open_if_mysql_is_off()
    {
        Setting::updateOrCreate('use_mysql', 'off');

        $this->dockerCompose->shouldNotReceive('runContainer');

        $this->artisan('mysql:open');

        $this->assertRegExp('/Not using docker mysql/', Artisan::output());
    }
}
